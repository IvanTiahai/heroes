<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Супергерої — візуальні картки</title>
  <style>
    :root{
      --bg:#0f1226; /* темний фон */
      --panel:#171a36;
      --card:#1c2043;
      --text:#e7e9ff;
      --muted:#9aa0c3;
      --accent:#7c8bff;
      --good:#2ecc71;
      --bad:#e74c3c;
      --chip:#28306b;
      --border:#2b2f55;
    }
    html,body{height:100%;}
    body{
      margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background:linear-gradient(180deg,#0b0d20 0%, var(--bg) 100%);
      color:var(--text);
    }
    .container{max-width:1200px;margin-inline:auto;padding:20px;}
    header{
      position:sticky; top:0; z-index:5; backdrop-filter:saturate(120%) blur(8px);
      background:linear-gradient(180deg, rgba(15,18,38,.95) 0%, rgba(15,18,38,.6) 100%);
      border-bottom:1px solid var(--border);
    }
    .controls{display:grid; gap:12px; grid-template-columns:1fr 180px 180px 1fr; align-items:center;}
    .controls > *{min-width:0;}
    .panel{padding:16px 20px;}
    .search{
      display:flex; align-items:center; gap:10px; background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:10px 12px;
    }
    .search input{all:unset; flex:1; color:var(--text);}
    .select, .range{
      background:var(--panel); border:1px solid var(--border); color:var(--text); border-radius:12px; padding:10px 12px; width:100%;
    }
    .range-wrap{display:flex; gap:10px; align-items:center;}
    .range{appearance:none; height:8px; border-radius:999px; background:#262b58; outline:none;}
    .range::-webkit-slider-thumb{appearance:none; width:18px; height:18px; border-radius:50%; background:var(--accent); border:2px solid #fff; cursor:pointer;}
    .grid{display:grid; gap:16px; grid-template-columns:repeat( auto-fill, minmax(240px, 1fr) );}

    .card{background:var(--card); border:1px solid var(--border); border-radius:16px; overflow:hidden; display:flex; flex-direction:column; box-shadow:0 6px 20px rgba(0,0,0,.25);}
    .thumb{aspect-ratio:4/5; background:#0a0c1d; position:relative;}
    .thumb img{position:absolute; inset:0; width:100%; height:100%; object-fit:cover;}
    .body{padding:12px 14px 14px; display:flex; flex-direction:column; gap:10px;}
    .title{display:flex; align-items:center; justify-content:space-between; gap:8px;}
    .name{font-weight:700; font-size:16px; line-height:1.2; letter-spacing:.2px;}
    .chips{display:flex; gap:6px; flex-wrap:wrap;}
    .chip{font-size:12px; padding:4px 8px; border-radius:999px; background:var(--chip); color:#cdd4ff; border:1px solid var(--border);}    
    .stats{display:grid; gap:6px;}
    .stat{display:grid; grid-template-columns:72px 1fr 34px; align-items:center; gap:8px; font-size:12px; color:var(--muted);} 
    .bar{position:relative; height:8px; background:#222655; border-radius:999px; overflow:hidden; border:1px solid var(--border);} 
    .bar > span{position:absolute; inset:0 auto 0 0; width:0; transition:width .6s ease; background:linear-gradient(90deg, var(--accent), #62e0ff);} 
    .val{justify-self:end; color:#cfd4ff;}

    .muted{color:var(--muted); font-size:12px;}
    .footer{display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .btn{background:transparent; border:1px solid var(--border); color:var(--text); padding:10px 14px; border-radius:12px; cursor:pointer;}
    .btn:hover{border-color:#4650b8;}

    .toolbar{display:flex; gap:10px; align-items:center; justify-content:flex-end;}
    .hidden{display:none !important;}
    .loader{display:grid; gap:12px; grid-template-columns:repeat( auto-fill, minmax(240px, 1fr) );}
    .skeleton{background:var(--card); border:1px solid var(--border); border-radius:16px; overflow:hidden;}
    .sk-thumb{height:240px; background:#0f1334;}
    .sk-line{height:12px; background:#2a2f66; margin:10px; border-radius:8px; opacity:.5;}

    @media (max-width: 820px){
      .controls{grid-template-columns:1fr;}
    }
  </style>
</head>
<body>
  <header>
    <div class="container panel">
      <div class="controls" role="search">
        <label class="search" title="Пошук за ім'ям або псевдонімами">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M21 21l-4.35-4.35" stroke="#cfd4ff" stroke-width="2" stroke-linecap="round"/><circle cx="11" cy="11" r="7" stroke="#cfd4ff" stroke-width="2"/></svg>
          <input id="q" placeholder="Пошук: Batman, Carol, Peter…" aria-label="Пошук" />
        </label>

        <select id="publisher" class="select" aria-label="Фільтр за видавцем">
          <option value="">Усі видавці</option>
        </select>

        <select id="alignment" class="select" aria-label="Спрямованість">
          <option value="">Будь-яка спрямованість</option>
          <option value="good">good</option>
          <option value="neutral">neutral</option>
          <option value="bad">bad</option>
        </select>

        <div class="range-wrap" title="Мінімальна середня характеристика">
          <input id="minStat" class="range" type="range" min="0" max="100" step="5" value="0" aria-label="Мінімальна середня характеристика" />
          <span id="minStatVal" class="muted" style="width:48px;text-align:right;">0</span>
        </div>
      </div>
    </div>
  </header>

  <main class="container" id="app" aria-live="polite">
    <section id="loader" class="loader" aria-busy="true" aria-label="Завантаження">
      <div class="skeleton"><div class="sk-thumb"></div><div class="sk-line"></div><div class="sk-line" style="width:60%"></div><div class="sk-line" style="width:80%"></div></div>
      <div class="skeleton"><div class="sk-thumb"></div><div class="sk-line"></div><div class="sk-line" style="width:60%"></div><div class="sk-line" style="width:80%"></div></div>
      <div class="skeleton"><div class="sk-thumb"></div><div class="sk-line"></div><div class="sk-line" style="width:60%"></div><div class="sk-line" style="width:80%"></div></div>
      <div class="skeleton"><div class="sk-thumb"></div><div class="sk-line"></div><div class="sk-line" style="width:60%"></div><div class="sk-line" style="width:80%"></div></div>
    </section>

    <section id="grid" class="grid hidden" aria-label="Список супергероїв"></section>

    <div class="toolbar" id="toolbar" hidden>
      <button id="moreBtn" class="btn" type="button">Показати ще</button>
      <span id="countTxt" class="muted"></span>
    </div>
  </main>

  <template id="card-tpl">
    <article class="card" tabindex="0">
      <div class="thumb">
        <img alt="Фото героя" loading="lazy" referrerpolicy="no-referrer" />
      </div>
      <div class="body">
        <div class="title">
          <div class="name"></div>
        </div>
        <div class="chips"></div>
        <div class="stats"></div>
        <div class="footer">
          <span class="muted"></span>
        </div>
      </div>
    </article>
  </template>

  <script>
  (function(){
    const API = 'https://akabab.github.io/superhero-api/api/all.json';
    const app = document.getElementById('app');
    const grid = document.getElementById('grid');
    const loader = document.getElementById('loader');
    const moreBtn = document.getElementById('moreBtn');
    const toolbar = document.getElementById('toolbar');
    const countTxt = document.getElementById('countTxt');

    const q = document.getElementById('q');
    const publisherSel = document.getElementById('publisher');
    const alignmentSel = document.getElementById('alignment');
    const minStat = document.getElementById('minStat');
    const minStatVal = document.getElementById('minStatVal');

    const tpl = document.getElementById('card-tpl');

    /** State */
    let all = [];
    let filtered = [];
    let page = 0;
    const PAGE_SIZE = 48;

    /** Utils */
    const avgStats = (s)=>{
      const vals = ['intelligence','strength','speed','durability','power','combat']
        .map(k => Number.isFinite(+s?.[k]) ? +s[k] : 0);
      const sum = vals.reduce((a,b)=>a+b,0);
      return Math.round(sum / vals.length);
    };

    const unique = (arr) => [...new Set(arr.filter(Boolean).sort())];

    function statRow(label, value){
      const wrap = document.createElement('div');
      wrap.className = 'stat';
      const l = document.createElement('span'); l.textContent = label;
      const bar = document.createElement('div'); bar.className = 'bar';
      const fill = document.createElement('span'); bar.appendChild(fill);
      const v = document.createElement('span'); v.className = 'val'; v.textContent = value ?? '—';
      wrap.append(l, bar, v);
      // animate width after insert
      requestAnimationFrame(()=>{ fill.style.width = ((+value||0)) + '%'; });
      return wrap;
    }

    function chip(text){
      const s = document.createElement('span'); s.className = 'chip'; s.textContent = text; return s;
    }

    function createCard(hero){
      const { images, name, biography, powerstats, appearance, work } = hero;
      const node = tpl.content.firstElementChild.cloneNode(true);
      const img = node.querySelector('img');
      img.src = images?.md || images?.lg || images?.sm;
      img.alt = `Зображення: ${name}`;

      node.querySelector('.name').textContent = name;

      const chips = node.querySelector('.chips');
      if (biography?.publisher) chips.appendChild(chip(biography.publisher));
      if (biography?.alignment) chips.appendChild(chip('align: '+biography.alignment));
      if (appearance?.race) chips.appendChild(chip(appearance.race));
      if (appearance?.gender) chips.appendChild(chip(appearance.gender));

      const stats = node.querySelector('.stats');
      const labels = {intelligence:'Інтелект', strength:'Сила', speed:'Швидкість', durability:'Витрив.', power:'Потуга', combat:'Бій'};
      Object.keys(labels).forEach(k=>{
        const v = (powerstats?.[k] ?? 0);
        stats.appendChild(statRow(labels[k], v));
      });

      const foot = node.querySelector('.footer .muted');
      const height = Array.isArray(appearance?.height) ? appearance.height.at(-1) : appearance?.height;
      const weight = Array.isArray(appearance?.weight) ? appearance.weight.at(-1) : appearance?.weight;
      foot.textContent = [biography?.fullName, height, weight].filter(Boolean).join(' • ');

      return node;
    }

    function render(reset=false){
      if(reset){ page = 0; grid.innerHTML=''; }
      const start = page * PAGE_SIZE;
      const slice = filtered.slice(start, start + PAGE_SIZE);
      const frag = document.createDocumentFragment();
      for(const h of slice){ frag.appendChild(createCard(h)); }
      grid.appendChild(frag);
      grid.classList.remove('hidden');
      loader.classList.add('hidden');
      page++;

      // Toolbar state
      const shown = Math.min(page*PAGE_SIZE, filtered.length);
      countTxt.textContent = `${shown} / ${filtered.length}`;
      toolbar.hidden = filtered.length <= PAGE_SIZE;
      moreBtn.disabled = shown >= filtered.length;
    }

    function applyFilters(){
      const term = q.value.trim().toLowerCase();
      const pub = publisherSel.value;
      const aln = alignmentSel.value;
      const min = +minStat.value;

      filtered = all.filter(h=>{
        const name = h.name?.toLowerCase() || '';
        const aliases = (h.biography?.aliases||[]).join(' ').toLowerCase();
        const byText = !term || name.includes(term) || aliases.includes(term);
        const byPub = !pub || h.biography?.publisher === pub;
        const byAln = !aln || h.biography?.alignment === aln;
        const byMin = avgStats(h.powerstats) >= min;
        return byText && byPub && byAln && byMin;
      });
      render(true);
    }

    function populateFilters(){
      const pubs = unique(all.map(x=>x.biography?.publisher));
      for(const p of pubs){
        const opt = document.createElement('option'); opt.value = p; opt.textContent = p; publisherSel.appendChild(opt);
      }
    }

    function bind(){
      q.addEventListener('input', debounce(applyFilters, 150));
      publisherSel.addEventListener('change', applyFilters);
      alignmentSel.addEventListener('change', applyFilters);
      minStat.addEventListener('input', ()=>{ minStatVal.textContent = minStat.value; });
      minStat.addEventListener('change', applyFilters);
      moreBtn.addEventListener('click', ()=>render(false));

      // Infinite scroll (optional enhancement)
      const onScroll = () => {
        if (toolbar.hidden) return;
        const nearBottom = window.innerHeight + window.scrollY >= document.body.offsetHeight - 200;
        if (nearBottom && !moreBtn.disabled){ render(false); }
      };
      window.addEventListener('scroll', onScroll, {passive:true});
    }

    function debounce(fn, ms){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(this,args), ms); } }

    async function init(){
      try{
        const res = await fetch(API, {cache:'force-cache'});
        if(!res.ok) throw new Error('Помилка завантаження API');
        all = await res.json();
        populateFilters();
        applyFilters();
      }catch(err){
        loader.innerHTML = `<div class="muted">${err.message}. Переконайтесь, що ви онлайн або спробуйте пізніше.</div>`;
      }
      bind();
      minStatVal.textContent = minStat.value;
    }

    init();
  })();
  </script>
</body>
</html>
